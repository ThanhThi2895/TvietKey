#!/usr/bin/make -f

export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export CARGO_HOME = $(CURDIR)/debian/cargo

# Build directory for CMake
BUILD_DIR = $(CURDIR)/debian/build
LINUX_SRC = $(CURDIR)/platforms/linux
CORE_LIB = $(CURDIR)/core/target/release/libgonhanh_core.so
DEST_DIR = $(CURDIR)/debian/fcitx5-gonhanh

%:
	dh $@

override_dh_auto_configure:
	# Build Rust core library first
	cd core && cargo build --release
	# Configure CMake for Linux addon
	mkdir -p $(BUILD_DIR)
	cd $(BUILD_DIR) && cmake $(LINUX_SRC) \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DBUILD_TESTS=OFF \
		-DRUST_LIB_DIR=$(CURDIR)/core/target/release

override_dh_auto_build:
	# Build Linux addon with CMake
	cd $(BUILD_DIR) && make -j$$(nproc)

override_dh_auto_test:
	# Skip tests during package build (run separately)
	@echo "Skipping tests during package build"

override_dh_auto_install:
	# Install via CMake
	cd $(BUILD_DIR) && make install DESTDIR=$(DEST_DIR)
	# Install CLI tool
	install -Dm755 platforms/linux/scripts/gonhanh-cli.sh \
		$(DEST_DIR)/usr/bin/gn
	# Install environment template
	install -Dm644 platforms/linux/data/90-gonhanh.conf.template \
		$(DEST_DIR)/usr/share/gonhanh/90-gonhanh.conf.template
	# Install version file
	mkdir -p $(DEST_DIR)/usr/share/gonhanh
	echo "1.0.0" > $(DEST_DIR)/usr/share/gonhanh/version

override_dh_auto_clean:
	rm -rf $(BUILD_DIR)
	cd core && cargo clean || true
	rm -rf $(CARGO_HOME)
